<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Smart Chef - Recipe Manager</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <!-- Custom Styles -->
    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }
        .font-brand {
            font-family: 'Playfair Display', serif;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        ::-webkit-scrollbar-thumb {
            background: #e11d48;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #be123c;
        }
    </style>
</head>
<body class="bg-rose-50 text-gray-800">

    <!-- Header -->
    <header class="bg-rose-600 text-white shadow-lg sticky top-0 z-20">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <img src="https://cdn-icons-png.flaticon.com/512/1046/1046857.png" alt="Chef Cap Logo" class="h-10 w-10">
                <h1 class="font-brand text-2xl md:text-3xl">Smart Chef</h1>
            </div>
            <button id="logoutBtn" class="hidden bg-white text-rose-600 font-semibold py-2 px-4 rounded-full shadow-md hover:bg-rose-100 transition-all duration-300 ease-in-out flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                <span class="hidden md:inline">Logout</span>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto p-4 md:p-6">
        <!-- Login View -->
        <div id="loginView" class="text-center max-w-md mx-auto mt-10 p-8 bg-white rounded-2xl shadow-xl">
            <img src="https://cdn-icons-png.flaticon.com/512/3597/3597178.png" alt="Recipe Book" class="w-24 h-24 mx-auto mb-4">
            <h2 class="text-3xl font-bold text-rose-600 mb-2">Welcome to Smart Chef</h2>
            <p class="text-gray-500 mb-6">Your personal recipe assistant. Login to manage your recipes.</p>
            <button id="loginBtn" class="w-full bg-rose-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-rose-700 transform hover:scale-105 transition-all duration-300 ease-in-out">
                Login / Get Started
            </button>
        </div>

        <!-- App View -->
        <div id="appView" class="hidden">
            <!-- User Info -->
            <div class="mb-6 p-4 bg-white border-2 border-rose-500 rounded-lg shadow-md text-center">
                <p class="font-semibold text-gray-700">Logged in as User ID:</p>
                <p id="userIdDisplay" class="text-rose-600 font-mono text-sm break-all"></p>
            </div>
            
            <!-- Voice Action Buttons -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                 <button id="voiceSearchBtn" class="w-full bg-blue-500 text-white font-bold py-3 px-5 rounded-lg shadow-md hover:bg-blue-600 transition-all duration-300 flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="11" y1="8" x2="11" y2="14"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg>
                    Voice Search Recipe
                </button>
                <button id="voiceAddBtn" class="w-full bg-green-500 text-white font-bold py-3 px-5 rounded-lg shadow-md hover:bg-green-600 transition-all duration-300 flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
                    Voice Add Recipe
                </button>
            </div>

            <!-- Add Recipe Form -->
            <form id="recipeForm" class="bg-white p-6 rounded-2xl shadow-xl mb-8">
                <h3 class="text-2xl font-bold text-rose-600 mb-4">Add a New Recipe</h3>
                <div class="space-y-4">
                    <input type="text" id="recipeName" placeholder="Recipe Name" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-rose-500 focus:border-transparent transition">
                    <input type="text" id="recipeIngredients" placeholder="Ingredients (comma separated)" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-rose-500 focus:border-transparent transition">
                    <textarea id="recipeSteps" placeholder="Steps (use '->' to separate)" required rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-rose-500 focus:border-transparent transition"></textarea>
                </div>
                <button type="submit" class="w-full mt-4 bg-rose-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-rose-700 transform hover:scale-105 transition-all duration-300 ease-in-out">Add Recipe</button>
            </form>

            <!-- Recipe List -->
            <h2 class="text-3xl font-bold text-center text-rose-600 mb-6">Your Recipes</h2>
            <div id="recipeList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Recipe cards will be inserted here -->
            </div>
            <div id="loading" class="text-center py-10 hidden">
                <p class="text-gray-500">Loading recipes...</p>
            </div>
            <div id="noRecipes" class="text-center py-10 hidden">
                 <img src="https://cdn-icons-png.flaticon.com/512/4076/4076413.png" alt="Empty notepad" class="w-20 h-20 mx-auto mb-4 opacity-50">
                <p class="text-gray-500">No recipes found. Add one to get started!</p>
            </div>
        </div>
    </main>

    <!-- Notification/Alert Modal -->
    <div id="notification" class="fixed top-5 right-5 z-50 bg-white p-4 rounded-lg shadow-lg border-l-4 transition-transform translate-x-[120%]" role="alert">
        <p id="notificationMessage"></p>
    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIG and INITIALIZATION ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-smart-chef';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let app, auth, db, userId, recipeUnsubscribe;
        let localRecipesCache = [];

        // --- UI ELEMENTS ---
        const loginView = document.getElementById('loginView');
        const appView = document.getElementById('appView');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const recipeForm = document.getElementById('recipeForm');
        const recipeList = document.getElementById('recipeList');
        const loadingDiv = document.getElementById('loading');
        const noRecipesDiv = document.getElementById('noRecipes');
        const voiceSearchBtn = document.getElementById('voiceSearchBtn');
        const voiceAddBtn = document.getElementById('voiceAddBtn');
        const notification = document.getElementById('notification');
        const notificationMessage = document.getElementById('notificationMessage');
        
        // --- NOTIFICATION FUNCTION ---
        function showNotification(message, type = 'success') {
            notificationMessage.textContent = message;
            notification.classList.remove('border-green-500', 'border-red-500', 'border-blue-500', 'translate-x-[120%]');
            
            if (type === 'success') {
                notification.classList.add('border-green-500');
            } else if (type === 'error') {
                notification.classList.add('border-red-500');
            } else {
                notification.classList.add('border-blue-500');
            }
            
            notification.classList.remove('translate-x-[120%]');
            notification.classList.add('translate-x-0');

            setTimeout(() => {
                notification.classList.remove('translate-x-0');
                notification.classList.add('translate-x-[120%]');
            }, 3000);
        }

        // --- AUTHENTICATION ---
        function setupAuth() {
            onAuthStateChanged(auth, user => {
                if (user) {
                    userId = user.uid;
                    loginView.classList.add('hidden');
                    appView.classList.remove('hidden');
                    logoutBtn.classList.remove('hidden');
                    userIdDisplay.textContent = userId;
                    listenForRecipes();
                } else {
                    userId = null;
                    loginView.classList.remove('hidden');
                    appView.classList.add('hidden');
                    logoutBtn.classList.add('hidden');
                    if (recipeUnsubscribe) recipeUnsubscribe();
                    recipeList.innerHTML = '';
                }
            });
        }
        
        loginBtn.addEventListener('click', async () => {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                showNotification('Logged in successfully!', 'success');
            } catch (error) {
                console.error("Login failed:", error);
                showNotification('Login failed. Please try again.', 'error');
            }
        });

        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                showNotification('Logged out successfully.', 'info');
            } catch (error) {
                console.error("Logout failed:", error);
                showNotification('Logout failed.', 'error');
            }
        });


        // --- FIRESTORE RECIPE MANAGEMENT ---
        function getRecipesCollectionRef() {
            return collection(db, 'artifacts', appId, 'users', userId, 'recipes');
        }

        function listenForRecipes() {
            if (!userId) return;
            loadingDiv.classList.remove('hidden');
            noRecipesDiv.classList.add('hidden');

            const recipesQuery = query(getRecipesCollectionRef());
            recipeUnsubscribe = onSnapshot(recipesQuery, (snapshot) => {
                loadingDiv.classList.add('hidden');
                localRecipesCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderRecipes(localRecipesCache);

                if (localRecipesCache.length === 0) {
                    noRecipesDiv.classList.remove('hidden');
                } else {
                    noRecipesDiv.classList.add('hidden');
                }
            }, (error) => {
                console.error("Error listening for recipes:", error);
                showNotification('Could not fetch recipes.', 'error');
                loadingDiv.classList.add('hidden');
            });
        }

        recipeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('recipeName').value.trim();
            const ingredients = document.getElementById('recipeIngredients').value.trim();
            const steps = document.getElementById('recipeSteps').value.trim();

            if (name && ingredients && steps) {
                try {
                    await addDoc(getRecipesCollectionRef(), { name, ingredients, steps });
                    showNotification('Recipe added successfully!', 'success');
                    recipeForm.reset();
                } catch (error) {
                    console.error("Error adding recipe:", error);
                    showNotification('Failed to add recipe.', 'error');
                }
            }
        });

        async function deleteRecipe(id) {
            if (confirm("Are you sure you want to delete this recipe?")) {
                 try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'recipes', id));
                    showNotification('Recipe deleted!', 'info');
                } catch (error) {
                    console.error("Error deleting recipe:", error);
                    showNotification('Failed to delete recipe.', 'error');
                }
            }
        }
        
        window.deleteRecipe = deleteRecipe; // Make it accessible from HTML onclick

        // --- RENDERING ---
        function renderRecipes(recipes) {
            recipeList.innerHTML = '';
            if (!recipes) return;

            recipes.forEach(r => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-xl shadow-lg overflow-hidden transform hover:-translate-y-1 transition-transform duration-300';
                card.innerHTML = `
                    <div class="p-6">
                        <h3 class="text-xl font-bold text-rose-600 mb-2">${r.name}</h3>
                        <div class="mb-4">
                            <p class="font-semibold text-gray-600">Ingredients:</p>
                            <p class="text-gray-500 text-sm">${r.ingredients}</p>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-600">Steps:</p>
                            <p class="text-gray-500 text-sm">${r.steps.replace(/->/g, '<br> ➤ ')}</p>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-4 text-right">
                         <button onclick="deleteRecipe('${r.id}')" class="bg-red-500 text-white font-semibold py-1 px-3 rounded-md hover:bg-red-600 transition-colors text-sm">Delete</button>
                    </div>
                `;
                recipeList.appendChild(card);
            });
        }

        // --- VOICE RECOGNITION ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'en-US';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            recognition.onresult = (event) => {
                const result = event.results[0][0].transcript;
                recognition.lastAction(result);
            };
            
            recognition.onerror = (event) => {
                showNotification(`Voice recognition error: ${event.error}`, 'error');
            };
        } else {
             showNotification('Voice recognition not supported in this browser.', 'error');
             voiceSearchBtn.disabled = true;
             voiceAddBtn.disabled = true;
        }

        voiceSearchBtn.addEventListener('click', () => {
            if (!recognition) return;
            recognition.lastAction = handleVoiceSearch;
            recognition.start();
            showNotification('Listening for a recipe name...', 'info');
        });
        
        voiceAddBtn.addEventListener('click', () => {
            if (!recognition) return;
            recognition.lastAction = handleVoiceAdd;
            recognition.start();
            showNotification("Say: '[Name], [Ingredients], [Steps]'", 'info');
        });

        function handleVoiceSearch(query) {
            const searchQuery = query.toLowerCase().trim();
            const found = localRecipesCache.find(r => r.name.toLowerCase().includes(searchQuery));
            if (found) {
                showNotification(`Found: ${found.name}`, 'success');
                // Highlight the found card
                const cards = recipeList.children;
                for(let card of cards) {
                    card.classList.remove('ring-4', 'ring-blue-400');
                    if(card.querySelector('h3').textContent === found.name) {
                        card.classList.add('ring-4', 'ring-blue-400');
                        card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            } else {
                showNotification(`No recipe found for "${query}"`, 'error');
            }
        }
        
        async function handleVoiceAdd(spokenText) {
            const parts = spokenText.split(',');
            if (parts.length >= 3) {
                const [name, ingredients, steps] = parts.map(p => p.trim());
                 try {
                    await addDoc(getRecipesCollectionRef(), { name, ingredients, steps });
                    showNotification('Recipe added by voice!', 'success');
                } catch (error) {
                    console.error("Error adding recipe by voice:", error);
                    showNotification('Failed to add recipe by voice.', 'error');
                }
            } else {
                showNotification("Voice command unclear. Please say: Recipe name, ingredients, steps.", 'error');
            }
        }

        // --- INITIALIZE APP ---
        function initialize() {
            if (Object.keys(firebaseConfig).length === 0) {
                document.body.innerHTML = '<div class="p-8 text-center text-red-600 bg-red-100">Firebase configuration is missing. The app cannot start.</div>';
                return;
            }
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setupAuth();
            } catch (error) {
                 document.body.innerHTML = `<div class="p-8 text-center text-red-600 bg-red-100">Error initializing Firebase: ${error.message}</div>`;
                 console.error("Firebase Init Error:", error);
            }
        }
        
        initialize();

    </script>
</body>
</html>
